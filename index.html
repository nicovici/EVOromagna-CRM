<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Lead Manager (Cloud)</title>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (per JSX in un singolo file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /***********************
     * CONFIG SUPABASE
     * Inserisci qui i tuoi valori (ti spiego sotto dove prenderli)
     ************************/
const SUPABASE_URL = "https://xaivhyylabxiisbecwtd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhaXZoeXlsYWJ4aWlzYmVjd3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDkxODMsImV4cCI6MjA4MzI4NTE4M30.E9HDphXGGjEAo2pC3r6WgOAWWTmROQt0WRTjfonUnpU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * UTIL
     ************************/
    const safeUUID = () => {
      // Chrome/Android moderni: crypto.randomUUID esiste
      if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
      // fallback: UUID semplice (sufficiente per uso pratico)
      const s4 = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
      return `${s4()}${s4()}-${s4()}-${s4()}-${s4()}-${s4()}${s4()}${s4()}`;
    };

    const parseFinancialValue = (str) => {
      if (!str || String(str).includes('#')) return 0;
      let cleaned = String(str).replace(/[^\d.,-]/g, '').trim();
      const isNegative = cleaned.startsWith('-');
      if (isNegative) cleaned = cleaned.substring(1);

      if (cleaned.includes('.') && cleaned.includes(',')) {
        cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      } else if (cleaned.includes('.')) {
        const parts = cleaned.split('.');
        if (parts.length > 2 || (parts[1] && parts[1].length === 3)) {
          cleaned = cleaned.replace(/\./g, '');
        }
      } else if (cleaned.includes(',')) {
        cleaned = cleaned.replace(',', '.');
      }

      const value = parseFloat(cleaned);
      return isNaN(value) ? 0 : Math.round(isNegative ? -value : value);
    };

    const formatCurrency = (v) => (v ? `‚Ç¨ ${Number(v).toLocaleString('it-IT')}` : '‚Ç¨ 0');

    const formatDateTime = (d) => {
      if (!d) return '';
      const dt = new Date(d);
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2,'0');
      const mi = String(dt.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    };

    // CSV: separatore ';' e prima riga intestazioni
        // Funzione parsing CSV (dinamica via intestazioni; separatore ';')
    const parseCSVData = (csvText) => {
      const lines = csvText.replace(/\r/g, '').split('\n');
      if (!lines.length) return [];

      const headerRaw = lines[0] || '';
      const headers = headerRaw.split(';').map(h => (h || '').trim());
      const norm = (s) => (s || '').toLowerCase().replace(/[^a-z0-9]/g, '');

      const idxOf = (...candidates) => {
        const set = new Set(candidates.map(norm));
        for (let i = 0; i < headers.length; i++) {
          if (set.has(norm(headers[i]))) return i;
        }
        return -1;
      };

      // Indici colonne (tolleranti a varianti)
      const iPiva = idxOf('piva', 'partitaiva', 'vat');
      const iRag = idxOf('ragionesociale', 'azienda', 'denominazione');
      const iTel = idxOf('telefono', 'tel', 'cellulare');
      const iInd = idxOf('indirizzo', 'via', 'street');
      const iComune = idxOf('comune', 'citta', 'citt√†', 'city');
      const iCap = idxOf('cap', 'zipcode', 'postalcode');
      const iProv = idxOf('provincia', 'prov', 'pr');
      const iEmail = idxOf('email', 'mail');
      const iSito = idxOf('sitoweb', 'sito', 'website', 'url');
      const iCollab = idxOf('collaboratori', 'collaboratore');
      const iDip = idxOf('dipendenti', 'dipendente');
      const iCapSoc = idxOf('capitalesociale', 'capitalsociale', 'capitale');
      const iValProd = idxOf('valoreproduzione', 'valoreproduz', 'valoreproduzioneannuo');
      const iRicavi = idxOf('ricavi', 'fatturato');
      const iUtile = idxOf('utile', 'utileoperdite', 'utileoperdita', 'perdite');
      const iSettore = idxOf('settore', 'ateco', 'categoria');
      const iNote = idxOf('note', 'nota', 'annotazioni');

      const expectedFields = headers.length || 0;
      const expectedSeps = Math.max(0, expectedFields - 1);

      const companies = [];
      let currentLine = '';

      for (let li = 1; li < lines.length; li++) {
        const line = lines[li];
        if (line === undefined) continue;

        currentLine += (currentLine ? '\n' : '') + line;
        const sepCount = (currentLine.match(/;/g) || []).length;

        // Accumula finch√© non abbiamo almeno i separatori attesi (gestione righe spezzate)
        if (sepCount < expectedSeps) continue;

        if (!currentLine.trim()) { currentLine = ''; continue; }

        const v = currentLine.split(';');
        // pad
        while (v.length < expectedFields) v.push('');

        const get = (idx) => (idx >= 0 ? (v[idx] || '').trim() : '');
        const getInt = (idx) => parseInt(get(idx), 10) || 0;

        const pivaRaw = get(iPiva);
        const piva = pivaRaw ? pivaRaw : `TMP-${safeUUID()}`;

        const note = get(iNote);
        const stato = note.toLowerCase().includes('non interessa') ? 'Non interessato' :
                      note.toLowerCase().includes('mail') ? 'Contattato' : 'Nuovo';

        const ragioneSociale = get(iRag);
        const indirizzo = [
          get(iInd),
          get(iComune),
          get(iCap),
          get(iProv) ? `(${get(iProv)})` : ''
        ].filter(Boolean).join(', ').trim();

        companies.push({
          _tmpId: `tmp_${Date.now()}_${li}_${Math.random().toString(36).slice(2)}`,
          piva,
          ragioneSociale,
          telefono: get(iTel).split(/[\s\n]/)[0],
          indirizzo,
          email: get(iEmail),
          sitoWeb: get(iSito),
          collaboratori: getInt(iCollab),
          dipendenti: getInt(iDip),
          capitaleSociale: parseFinancialValue(get(iCapSoc)),
          valoreProduzione: parseFinancialValue(get(iValProd)),
          ricavi: parseFinancialValue(get(iRicavi)),
          utileOPerdite: parseFinancialValue(get(iUtile)),
          settore: get(iSettore),
          titolare: '',
          stato,
          tagPriorita: 'Nuovo',
          evidenza: '',
          timeline: note ? [{
            id: `t_${Date.now()}_${Math.random()}`,
            data: new Date().toISOString(),
            tipo: 'nota',
            testo: `Note da file: ${note}`,
            operatore: 'Import'
          }] : [],
          dataCreazione: new Date().toISOString()
        });

        currentLine = '';
      }

      return companies;
    };;

    /***********************
     * MAPPING DB <-> UI
     ************************/
    const fromDbCompany = (row) => ({
      id: row.id,
      piva: row.piva,
      ragioneSociale: row.ragione_sociale || '',
      telefono: row.telefono || '',
      indirizzo: row.indirizzo || '',
      email: row.email || '',
      sitoWeb: row.sito_web || '',
      collaboratori: row.collaboratori || 0,
      dipendenti: row.dipendenti || 0,
      capitaleSociale: row.capitale_sociale || 0,
      valoreProduzione: row.valore_produzione || 0,
      ricavi: row.ricavi || 0,
      utileOPerdite: row.utile_o_perdite || 0,
      settore: row.settore || '',
      titolare: row.titolare || '',
      stato: row.stato || 'Nuovo',
      tagPriorita: row.tag_priorita || 'Nuovo',
      evidenza: row.evidenza || '',
      timeline: Array.isArray(row.timeline) ? row.timeline : (row.timeline || []),

      // Follow-up (slot) + pianificazione blocchi
      followupSlotId: row.followup_slot_id || null,
      followupEnteredAt: row.followup_entered_at || null,
      plannedBlockId: row.planned_block_id || null,
      plannedAt: row.planned_at || null,

      dataCreazione: row.created_at,
    });

    const toDbCompany = (c, userId) => ({
      id: c.id, // pu√≤ essere undefined per insert
      user_id: userId,
      piva: c.piva,
      ragione_sociale: c.ragioneSociale,
      telefono: c.telefono,
      indirizzo: c.indirizzo,
      email: c.email,
      sito_web: c.sitoWeb,
      collaboratori: Number(c.collaboratori || 0),
      dipendenti: Number(c.dipendenti || 0),
      capitale_sociale: Number(c.capitaleSociale || 0),
      valore_produzione: Number(c.valoreProduzione || 0),
      ricavi: Number(c.ricavi || 0),
      utile_o_perdite: Number(c.utileOPerdite || 0),
      settore: c.settore,
      titolare: c.titolare,
      stato: c.stato,
      tag_priorita: c.tagPriorita,
      evidenza: c.evidenza,
      timeline: c.timeline || [],

      // Follow-up (slot) + pianificazione blocchi
      followup_slot_id: c.followupSlotId || null,
      followup_entered_at: c.followupEnteredAt || null,
      planned_block_id: c.plannedBlockId || null,
      planned_at: c.plannedAt || null,
    });

    /***********************
     * AUTH UI
     ************************/
    const AuthPanel = ({ onAuthed }) => {
      const [mode, setMode] = useState('login'); // login | signup
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [msg, setMsg] = useState('');

      const submit = async () => {
        setMsg('');
        setLoading(true);
        try {
          if (mode === 'signup') {
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            setMsg('Registrazione ok. Se hai attivato la conferma email, controlla la posta.');
          } else {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            onAuthed();
          }
        } catch (e) {
          setMsg(e.message || 'Errore');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="bg-white shadow rounded-xl p-6 w-full max-w-md">
            <h1 className="text-2xl font-bold mb-2">CRM Lead Manager</h1>
            <p className="text-sm text-gray-600 mb-6">Accesso al database online</p>

            <div className="flex gap-2 mb-4">
              <button
                className={`flex-1 px-3 py-2 rounded ${mode==='login'?'bg-blue-600 text-white':'bg-gray-100'}`}
                onClick={() => setMode('login')}
              >Login</button>
              <button
                className={`flex-1 px-3 py-2 rounded ${mode==='signup'?'bg-blue-600 text-white':'bg-gray-100'}`}
                onClick={() => setMode('signup')}
              >Registrati</button>
            </div>

            <label className="text-sm text-gray-700">Email</label>
            <input className="border rounded px-3 py-2 w-full mb-3" value={email} onChange={e=>setEmail(e.target.value)} />

            <label className="text-sm text-gray-700">Password</label>
            <input type="password" className="border rounded px-3 py-2 w-full mb-4" value={password} onChange={e=>setPassword(e.target.value)} />

            <button
              onClick={submit}
              disabled={loading || !email || !password}
              className="w-full bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50"
            >
              {loading ? '...' : (mode==='login' ? 'Entra' : 'Crea account')}
            </button>

            {msg && <div className="mt-4 text-sm bg-yellow-50 border border-yellow-200 rounded p-3 text-yellow-800">{msg}</div>}

            <div className="mt-6 text-xs text-gray-500">
              Nota: per sicurezza, abilita le policy RLS in Supabase come da guida.
            </div>
          </div>
        </div>
      );
    };

    /***********************
     * APP
     ************************/
    const CRMLeadManager = () => {
      const [session, setSession] = useState(null);
      const [loadingApp, setLoadingApp] = useState(true);

      const [companies, setCompanies] = useState([]);
      const [selectedCompanies, setSelectedCompanies] = useState([]);
      const [currentView, setCurrentView] = useState('dashboard'); // dashboard | companies | detail | settings-stati
      const [selectedCompanyId, setSelectedCompanyId] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

      const [statiPersonalizzati, setStatiPersonalizzati] = useState(['Nuovo','Da contattare','Contattato','In trattativa','Acquisito','Non interessato']);
      const [newStatoName, setNewStatoName] = useState('');
      const [showNewStatoInput, setShowNewStatoInput] = useState(false);

      // note/timeline UI
      const [showNoteInput, setShowNoteInput] = useState(false);
      const [newNoteText, setNewNoteText] = useState('');
      const [editingNote, setEditingNote] = useState(null);
      const [deletingNote, setDeletingNote] = useState(null);
      const [draggedNoteIndex, setDraggedNoteIndex] = useState(null);

      // voce
      const [isListening, setIsListening] = useState(false);
      const [voiceReview, setVoiceReview] = useState({ open: false, summary: '', updated: [], working: false });
      const [toast, setToast] = useState(null); // {type:'info'|'error'|'success', text:string}

      // follow-up (slot) e blocchi di chiamata
      const [followupSlots, setFollowupSlots] = useState([]); // [{id,nome,regole}]
      const [blocks, setBlocks] = useState([]); // [{id,slot_id,titolo,start_at,end_at,created_at}]
      const [slotDetailId, setSlotDetailId] = useState(null); // slot selezionato in vista follow-up
      const [selectedInSlot, setSelectedInSlot] = useState([]); // company ids selezionati dentro lo slot
      const [currentBlockId, setCurrentBlockId] = useState(null); // per deep-link #block=
      const [blockWizard, setBlockWizard] = useState({ open:false, slotId:null, start:'', end:'', durationMin:10 });

      const recognitionRef = useRef(null);

      const notify = (type, text) => {
        setToast({ type, text });
        // auto-hide
        setTimeout(() => setToast(null), 4000);
      };


      const userId = session?.user?.id || null;

      const selectedCompany = useMemo(
        () => companies.find(c => c.id === selectedCompanyId) || null,
        [companies, selectedCompanyId]
      );

      const filtered = useMemo(() => {
        const t = searchTerm.trim().toLowerCase();
        if (!t) return companies;
        return companies.filter(c =>
          (c.ragioneSociale || '').toLowerCase().includes(t) ||
          (c.piva || '').toLowerCase().includes(t) ||
          (c.email || '').toLowerCase().includes(t) ||
          (c.telefono || '').toLowerCase().includes(t) ||
          (c.settore || '').toLowerCase().includes(t)
        );
      }, [companies, searchTerm]);

      /***************
       * AUTH bootstrap
       ***************/
      useEffect(() => {
        (async () => {
          const { data } = await supabase.auth.getSession();
          setSession(data.session);
          setLoadingApp(false);
        })();

        const { data: sub } = supabase.auth.onAuthStateChange((_event, newSession) => {
          setSession(newSession);
        });

        return () => { sub.subscription.unsubscribe(); };
      }, []);

      const signOut = async () => {
        await supabase.auth.signOut();
        setCompanies([]);
        setSelectedCompanies([]);
        setSelectedCompanyId(null);
        setCurrentView('dashboard');
      };

      /***************
       * LOAD data
       ***************/
      const loadStati = async () => {
        const { data, error } = await supabase
          .from('stati')
          .select('*')
          .eq('user_id', userId)
          .order('ordine', { ascending: true });

        if (error) throw error;

        if (!data || data.length === 0) {
          // primo avvio: inseriamo default
          const defaults = ['Nuovo','Da contattare','Contattato','In trattativa','Acquisito','Non interessato'];
          const rows = defaults.map((nome, idx) => ({ user_id: userId, nome, ordine: idx+1 }));
          const ins = await supabase.from('stati').insert(rows);
          if (ins.error) throw ins.error;
          setStatiPersonalizzati(defaults);
          return;
        }
        setStatiPersonalizzati(data.map(r => r.nome));
      };

      const loadCompanies = async () => {
        const { data, error } = await supabase
          .from('companies')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: false });

        if (error) throw error;
        setCompanies((data || []).map(fromDbCompany));
      };


      const loadFollowupSlots = async () => {
        const { data, error } = await supabase
          .from('followup_slots')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: true });

        if (error) throw error;
        setFollowupSlots(data || []);
      };

      const loadBlocks = async () => {
        const { data, error } = await supabase
          .from('followup_blocks')
          .select('*')
          .eq('user_id', userId)
          .order('start_at', { ascending: false });

        if (error) throw error;
        setBlocks(data || []);
      };

      const getSlotName = (slotId) => {
        const s = (followupSlots || []).find(x => x.id === slotId);
        return s ? s.nome : '';
      };

      const statusPriorityIndex = (stato) => {
        const idx = (statiPersonalizzati || []).findIndex(s => String(s).toLowerCase() === String(stato||'').toLowerCase());
        return idx >= 0 ? idx : 9999;
      };

      const crmBaseUrl = () => {
        // Manteniamo eventuale path di GitHub Pages (repo) e usiamo hash per deep-link
        const { origin, pathname } = window.location;
        return origin + pathname;
      };

      const googleCalendarLink = ({ title, startISO, endISO, details }) => {
        // start/end in formato YYYYMMDDTHHMMSSZ
        const toGCal = (iso) => new Date(iso).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
        const dates = `${toGCal(startISO)}/${toGCal(endISO)}`;
        const url = new URL('https://calendar.google.com/calendar/render');
        url.searchParams.set('action', 'TEMPLATE');
        url.searchParams.set('text', title);
        url.searchParams.set('dates', dates);
        url.searchParams.set('details', details || '');
        return url.toString();
      };

      const assignCompanyToSlot = async (companyId, slotId) => {
        // Sposta l'azienda nello slot (follow-up), azzerando eventuale pianificazione precedente
        const nowIso = new Date().toISOString();

        const { data, error } = await supabase
          .from('companies')
          .update({
            followup_slot_id: slotId,
            followup_entered_at: nowIso,
            planned_block_id: null,
            planned_at: null
          })
          .eq('user_id', userId)
          .eq('id', companyId)
          .select('*')
          .single();

        if (error) throw error;

        const saved = fromDbCompany(data);
        setCompanies(prev => prev.map(c => c.id === saved.id ? saved : c));
        return saved;
      };

      const clearCompanyFollowup = async (companyId) => {
        const { data, error } = await supabase
          .from('companies')
          .update({
            followup_slot_id: null,
            followup_entered_at: null,
            planned_block_id: null,
            planned_at: null
          })
          .eq('user_id', userId)
          .eq('id', companyId)
          .select('*')
          .single();

        if (error) throw error;

        const saved = fromDbCompany(data);
        setCompanies(prev => prev.map(c => c.id === saved.id ? saved : c));
        return saved;
      };

      const createFollowupBlock = async ({ slotId, companyIds, startISO, endISO }) => {
        if (!slotId) throw new Error('Slot mancante.');
        if (!companyIds || companyIds.length === 0) throw new Error('Seleziona almeno un‚Äôazienda.');
        if (!startISO || !endISO) throw new Error('Inserisci inizio e fine del blocco.');

        const slotName = getSlotName(slotId) || 'Follow-up';
        const title = `${slotName} (${companyIds.length})`;

        const { data: blockRow, error: blockErr } = await supabase
          .from('followup_blocks')
          .insert({
            user_id: userId,
            slot_id: slotId,
            titolo: title,
            start_at: startISO,
            end_at: endISO
          })
          .select('*')
          .single();

        if (blockErr) throw blockErr;

        // Marca le aziende come "planned" sul blocco creato
        const nowIso = new Date().toISOString();
        const { error: updErr } = await supabase
          .from('companies')
          .update({ planned_block_id: blockRow.id, planned_at: nowIso })
          .eq('user_id', userId)
          .in('id', companyIds);

        if (updErr) throw updErr;

        await loadBlocks();
        await loadCompanies();

        return blockRow;
      };

      useEffect(() => {
        if (!userId) return;
        (async () => {
          try {
            setLoadingApp(true);
            await loadStati();
            await loadFollowupSlots();
            await loadBlocks();
            await loadCompanies();
} catch (e) {
            alert(`Errore caricamento dati: ${e.message || e}`);
          } finally {
            setLoadingApp(false);
          }
        })();
      }, [userId]);

      // Deep-link: #block=<uuid> per aprire direttamente un blocco dal calendario
      useEffect(() => {
        const applyHash = () => {
          const h = (window.location.hash || '').replace(/^#/, '');
          const m = h.match(/^block=([0-9a-f\-]{10,})/i);
          if (m && m[1]) {
            setCurrentBlockId(m[1]);
            setCurrentView('block');
            return;
          }
        };
        applyHash();
        window.addEventListener('hashchange', applyHash);
        return () => window.removeEventListener('hashchange', applyHash);
      }, []);


      /***************
       * SAVE helpers
       ***************/
      const saveCompany = async (company) => {
        // upsert su (user_id, piva)
        const payload = toDbCompany(company, userId);
        const { data, error } = await supabase
          .from('companies')
          .upsert(payload, { onConflict: 'user_id,piva' })
          .select('*')
          .single();

        if (error) throw error;

        const saved = fromDbCompany(data);
        setCompanies(prev => {
          const idx = prev.findIndex(x => x.id === saved.id);
          if (idx >= 0) {
            const copy = [...prev];
            copy[idx] = saved;
            return copy;
          }
          // se era nuovo (senza id) lo aggiungiamo in testa
          return [saved, ...prev];
        });
        return saved;
      };

      const deleteCompanies = async (ids) => {
        const { error } = await supabase
          .from('companies')
          .delete()
          .in('id', ids)
          .eq('user_id', userId);

        if (error) throw error;

        setCompanies(prev => prev.filter(c => !ids.includes(c.id)));
        setSelectedCompanies([]);
        setShowDeleteConfirm(false);
      };

/***************
 * CSV import
 ***************/
const handleCSVImport = async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  try {
    if (!userId) throw new Error('Devi essere loggato per importare.');

    const text = await file.text();
    const parsed = parseCSVData(text);

    // Validazioni base + normalizzazioni
    const problems = [];
    const candidates = parsed.map((c, idx) => {
      const piva = (c.piva || '').trim() || `TMP-${safeUUID()}`;
      const rag = (c.ragioneSociale || '').trim();

      if (!rag) problems.push({ idx, reason: 'Ragione Sociale mancante' });

      return {
        ...c,
        piva,
        ragioneSociale: rag
      };
    });

    // Scarta righe invalide (per ora: ragione sociale mancante)
    const invalidIdx = new Set(problems.map(p => p.idx));
    const valid = candidates.filter((_, i) => !invalidIdx.has(i));

    // Se non c'√® nulla di valido, esci
    if (valid.length === 0) {
      alert(`Nessun record importabile. Problemi trovati: ${problems.length}`);
      return;
    }

    // Pre-check duplicati su DB per PIVA (non sovrascriviamo: saltiamo)
    const pivas = [...new Set(valid.map(c => c.piva))];

    const existing = new Set();
    const chunkSize = 200; // prudente
    for (let i = 0; i < pivas.length; i += chunkSize) {
      const chunk = pivas.slice(i, i + chunkSize);
      const { data, error } = await supabase
        .from('companies')
        .select('piva')
        .in('piva', chunk);

      if (error) throw error;
      (data || []).forEach(r => existing.add(r.piva));
    }

    const toImport = [];
    let dupCount = 0;

    valid.forEach(c => {
      if (existing.has(c.piva)) {
        dupCount += 1;
        return; // skip (non sovrascrive)
      }
      toImport.push(c);
    });

    const skipInvalid = problems.length;
    const skipDup = dupCount;
    const skipTotal = skipInvalid + skipDup;

    const msg =
      `Verifica import CSV:\n\n` +
      `‚Ä¢ Record letti: ${parsed.length}\n` +
      `‚Ä¢ Importer√†: ${toImport.length}\n` +
      `‚Ä¢ NON importer√†: ${skipTotal}\n` +
      `   - Duplicati PIVA gi√† presenti: ${skipDup}\n` +
      `   - Righe non valide: ${skipInvalid}\n\n` +
      `Vuoi procedere con l'importazione?`;

    if (!confirm(msg)) return;

    if (toImport.length === 0) {
      alert('Nessun record da importare (tutti duplicati o non validi).');
      return;
    }

    // =============== FIX QUI: payload con ID SEMPRE valorizzato ===============
    // Per evitare l'errore "id null", generiamo SEMPRE un uuid per ogni record importato.
    // Usiamo crypto.randomUUID() se disponibile, altrimenti safeUUID().
    const genId = () => (crypto?.randomUUID ? crypto.randomUUID() : safeUUID());

    const payload = toImport.map(c => {
      const row = toDbCompany(c, userId);

      // IMPORTANTISSIMO:
      // 1) Non vogliamo MAI inviare id: null
      // 2) Vogliamo inviare SEMPRE un id pieno in import
      // Quindi lo forziamo qui.
      row.id = genId();

      return row;
    });
    // =======================================================================

    // Insert puro: non sovrascrive
    const { data, error } = await supabase
      .from('companies')
      .insert(payload)
      .select('*');

    if (error) throw error;

    await loadCompanies();

    alert(`Import completato: ${toImport.length} inseriti, ${skipTotal} saltati.`);
  } catch (err) {
    alert(`Errore import CSV: ${err.message || err}`);
  } finally {
    e.target.value = '';
  }
};

      /***************
       * Voice
       ***************/
      useEffect(() => {
        if (!userId) return;
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;

        const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
        const rec = new SR();
        rec.continuous = false;
        rec.lang = 'it-IT';

        rec.onresult = (e) => {
          const transcript = e.results[0][0].transcript;
          processVoiceCommand(transcript);
        };
        rec.onend = () => setIsListening(false);
        rec.onerror = (e) => {
          setIsListening(false);
          alert(`Errore riconoscimento vocale: ${e.error}`);
        };

        recognitionRef.current = rec;
      }, [userId, selectedCompanyId, selectedCompanies, currentView, companies]);

      const toggleMicrophone = () => {
        if (!recognitionRef.current) {
          alert('Riconoscimento vocale non disponibile su questo dispositivo/browser.');
          return;
        }
        if (isListening) {
          try { recognitionRef.current.stop(); } catch {}
          setIsListening(false);
        } else {
          try { recognitionRef.current.start(); setIsListening(true); } catch (e) {
            notify('error', 'Impossibile avviare il microfono. Usa HTTPS e concedi i permessi al browser.');
          }
        }
      };

      const processVoiceCommand = async (cmd) => {
        const low = (cmd || '').toLowerCase().trim();
        if (!low) return;

        // Navigazione semplice
        if (low.includes('apri aziende')) { setCurrentView('companies'); return; }
        if (low.includes('apri dashboard')) { setCurrentView('dashboard'); return; }
        if (low.includes('apri comandi vocali') || low.includes('comandi vocali')) { setCurrentView('voice-help'); return; }

        // Determina target (se hai selezionato pi√π aziende in lista, agisce su quelle; altrimenti su dettaglio)
        const anyIds = selectedCompanies && selectedCompanies.length ? selectedCompanies : [];
        const targetIds = anyIds.length
          ? anyIds
          : ((selectedCompanyId && currentView === 'detail') ? [selectedCompanyId] : []);

        if (targetIds.length === 0) {
          alert('Seleziona un‚Äôazienda (oppure apri una scheda) prima di dare comandi vocali che modificano dati.');
          return;
        }

        // Helper: trova stato valido
        const matchStatus = (wanted) => {
          const w = (wanted || '').trim().toLowerCase();
          if (!w) return null;
          const found = (statiPersonalizzati || []).find(s => String(s).toLowerCase() === w);
          return found || null;
        };

        // Riconoscimento comandi (modifica dati)
        let noteText = null;
        let evidenzaText = null;
        let statoWanted = null;
        let followupWanted = null;
// 1) Nota
        if (low.startsWith('aggiungi nota')) {
          noteText = cmd.substring(cmd.toLowerCase().indexOf('aggiungi nota') + 'aggiungi nota'.length).trim();
        } else if (low.startsWith('nota ')) {
          noteText = cmd.substring(cmd.toLowerCase().indexOf('nota ') + 'nota '.length).trim();
        }

        // 2) Evidenza
        if (low.startsWith('evidenza')) {
          evidenzaText = cmd.substring(cmd.toLowerCase().indexOf('evidenza') + 'evidenza'.length).trim();
        } else if (low.startsWith('imposta evidenza')) {
          evidenzaText = cmd.substring(cmd.toLowerCase().indexOf('imposta evidenza') + 'imposta evidenza'.length).trim();
        } else if (low.startsWith('metti in evidenza')) {
          evidenzaText = cmd.substring(cmd.toLowerCase().indexOf('metti in evidenza') + 'metti in evidenza'.length).trim();
        }

        // 3) Stato
        if (low.startsWith('imposta stato')) {
          statoWanted = cmd.substring(cmd.toLowerCase().indexOf('imposta stato') + 'imposta stato'.length).trim();
        } else if (low.startsWith('stato ')) {
          statoWanted = cmd.substring(cmd.toLowerCase().indexOf('stato ') + 'stato '.length).trim();
        }



        // 4) Follow-up (slot)
        // NOTA: usiamo la parola chiave "follow-up" per distinguere dagli appuntamenti puntuali
        if (low.startsWith('follow-up')) {
          followupWanted = cmd.substring(cmd.toLowerCase().indexOf('follow-up') + 'follow-up'.length).trim();
        } else if (low.startsWith('imposta follow-up')) {
          followupWanted = cmd.substring(cmd.toLowerCase().indexOf('imposta follow-up') + 'imposta follow-up'.length).trim();
        } else if (low.startsWith('cancella follow-up') || low.startsWith('rimuovi follow-up')) {
          followupWanted = '__CLEAR__';
        }

        const matchSlot = (wanted) => {
          const w = (wanted || '').trim().toLowerCase();
          if (!w) return null;
          const found = (followupSlots || []).find(s => String(s.nome || '').toLowerCase() === w);
          return found || null;
        };
        const statusMatched = statoWanted ? matchStatus(statoWanted) : null;

        const followupSlotMatched = (followupWanted && followupWanted !== '__CLEAR__') ? matchSlot(followupWanted) : null;
        if (followupWanted && followupWanted !== '__CLEAR__' && !followupSlotMatched) {
          notify('error', `Slot follow-up non riconosciuto: "${followupWanted}". Vai su Follow-up per creare/vedere gli slot disponibili.`);
          return;
        }
        if (statoWanted && !statusMatched) {
          notify('error', `Stato non riconosciuto: "${statoWanted}". Vai in Impostazioni ‚Üí Gestione Stati per vedere gli stati disponibili.`);
          return;
        }

        const hasAnyAction = (noteText && noteText.length) || (evidenzaText && evidenzaText.length) || statusMatched || (followupWanted && followupWanted.length);
        if (!hasAnyAction) {
          notify('info', 'Comando vocale non riconosciuto. Esempi: "aggiungi nota ...", "evidenza ...", "imposta stato Contattato".');
          return;
        }

        // Costruisci versione "modificata" delle aziende, SENZA salvare (prima mostriamo popup)
        const updatedCompanies = targetIds.map(id => {
          const original = companies.find(c => c.id === id);
          if (!original) return null;

          const patch = {};
          if (evidenzaText && evidenzaText.length) patch.evidenza = evidenzaText;
          if (statusMatched) patch.stato = statusMatched;

          // Follow-up (slot): spostando follow-up, rimuoviamo eventuale pianificazione precedente
          if (followupWanted) {
            if (followupWanted === '__CLEAR__') {
              patch.followupSlotId = null;
              patch.followupEnteredAt = null;
              patch.plannedBlockId = null;
              patch.plannedAt = null;
            } else if (followupSlotMatched) {
              patch.followupSlotId = followupSlotMatched.id;
              patch.followupEnteredAt = new Date().toISOString();
              patch.plannedBlockId = null;
              patch.plannedAt = null;
            }
          }

          let timeline = Array.isArray(original.timeline) ? [...original.timeline] : [];
          if (noteText && noteText.length) {
            timeline.push({
              id: `t_${Date.now()}_${Math.random()}`,
              data: new Date().toISOString(),
              tipo: 'nota',
              testo: noteText,
              operatore: 'Voce'
            });
          }

          return { ...original, ...patch, timeline };
        }).filter(Boolean);

        // Riepilogo leggibile
        const namesPreview = updatedCompanies.slice(0, 8).map(c => `‚Ä¢ ${c.ragioneSociale}`).join('\n');
        const more = updatedCompanies.length > 8 ? `
‚Ä¶e altre ${updatedCompanies.length - 8}` : '';

        const actions = [];
        if (noteText && noteText.length) actions.push(`Aggiunge NOTA: "${noteText}"`);
        if (evidenzaText && evidenzaText.length) actions.push(`Imposta EVIDENZA: "${evidenzaText}"`);
        if (statusMatched) actions.push(`Imposta STATO: "${statusMatched}"`);
        if (followupWanted === '__CLEAR__') actions.push('Rimuove FOLLOW-UP (slot)');
        if (followupSlotMatched) actions.push(`Imposta FOLLOW-UP (slot): "${followupSlotMatched.nome}"`);

        const summary =
          `Aziende coinvolte: ${updatedCompanies.length}

` +
          `Modifiche:
- ${actions.join('\n- ')}

` +
          `Elenco (prime):
${namesPreview}${more}

` +
          `Vuoi confermare?`;

        setVoiceReview({ open: true, summary, updated: updatedCompanies, working: false });
      };


      /***************
       * Stati: salva ordine su DB
       ***************/
      const persistStati = async (newList) => {
        setStatiPersonalizzati(newList);
        const rows = newList.map((nome, idx) => ({ user_id: userId, nome, ordine: idx+1 }));
        // strategia semplice: cancello e reinserisco
        const del = await supabase.from('stati').delete().eq('user_id', userId);
        if (del.error) throw del.error;
        const ins = await supabase.from('stati').insert(rows);
        if (ins.error) throw ins.error;
      };

      /***************
       * UI actions
       ***************/
      const openDetail = (c) => {
        setSelectedCompanyId(c.id);
        setCurrentView('detail');
        setShowNoteInput(false);
        setEditingNote(null);
        setDeletingNote(null);
        setNewNoteText('');
      };

      const updateSelectedCompanyLocal = (patch) => {
        if (!selectedCompany) return;
        setCompanies(prev => prev.map(c => c.id === selectedCompany.id ? { ...c, ...patch } : c));
      };

      const saveSelectedCompany = async () => {
        if (!selectedCompany) return;
        try {
          await saveCompany(selectedCompany);
        } catch (e) {
          alert(`Errore salvataggio: ${e.message || e}`);
        }
      };

      if (loadingApp) {
        return (
          <div className="min-h-screen flex items-center justify-center text-gray-600">
            Caricamento...
          </div>
        );
      }

      if (!session) {
        return <AuthPanel onAuthed={() => {}} />;
      }

      return (
        <div className="min-h-screen">
          <header className="bg-white shadow-sm">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center gap-4">
              <div>
                <h1 className="text-2xl font-bold">CRM Lead Manager</h1>
                <div className="text-xs text-gray-500">DB online ‚Ä¢ Utente: {session.user.email}</div>
              </div>

              <div className="flex items-center gap-2">
                {isListening && (
                  <div className="flex items-center gap-2 bg-red-50 px-3 py-2 rounded">
                    <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span className="text-sm text-red-700">üé§ In ascolto...</span>
                  </div>
                )}
                <button onClick={signOut} className="bg-gray-800 text-white px-3 py-2 rounded text-sm">Esci</button>
              </div>
            </div>
          </header>

          <nav className="bg-white border-b">
            <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
              <button onClick={() => setCurrentView('dashboard')}
                className={`px-4 py-3 border-b-2 whitespace-nowrap ${currentView === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>
                Dashboard
              </button>
              <button onClick={() => setCurrentView('companies')}
                className={`px-4 py-3 border-b-2 whitespace-nowrap ${['companies','detail'].includes(currentView) ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>
                Aziende
              </button>
              <button onClick={() => { setCurrentView('followup'); setSlotDetailId(null); setSelectedInSlot([]); }}
                className={`px-4 py-3 border-b-2 whitespace-nowrap ${currentView === 'followup' || currentView === 'block' ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>
                Follow-up
              </button>
              <button onClick={() => setCurrentView('settings-stati')}
                className={`px-4 py-3 border-b-2 whitespace-nowrap ${currentView === 'settings-stati' ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>
                Gestione Stati
              </button>
              <button onClick={() => setCurrentView('voice-help')}
                className={`px-4 py-3 border-b-2 whitespace-nowrap ${currentView === 'voice-help' ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>
                Comandi vocali
              </button>
            </div>
          </nav>

          <main className="max-w-7xl mx-auto">
            {currentView === 'dashboard' && (
              <div className="p-4 sm:p-6">
                <h2 className="text-2xl font-bold mb-6">Dashboard</h2>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                  <div className="bg-white p-5 rounded shadow">
                    <p className="text-gray-500 text-sm">Totale Aziende</p>
                    <p className="text-3xl font-bold">{companies.length}</p>
                  </div>
                  <div className="bg-white p-5 rounded shadow">
                    <p className="text-gray-500 text-sm">Da Contattare</p>
                    <p className="text-3xl font-bold">{companies.filter(c => c.stato === 'Nuovo' || c.stato === 'Da contattare').length}</p>
                  </div>
                  <div className="bg-white p-5 rounded shadow">
                    <p className="text-gray-500 text-sm">Contattati</p>
                    <p className="text-3xl font-bold">{companies.filter(c => c.stato === 'Contattato').length}</p>
                  </div>
                  <div className="bg-white p-5 rounded shadow">
                    <p className="text-gray-500 text-sm">Acquisiti</p>
                    <p className="text-3xl font-bold">{companies.filter(c => c.stato === 'Acquisito').length}</p>
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded p-5">
                  <h3 className="font-bold text-blue-800 mb-1">‚úÖ Dati online</h3>
                  <p className="text-blue-700 text-sm">
                    I dati sono salvati su database Supabase (non in locale).
                  </p>
                </div>
              </div>
            )}

            {currentView === 'companies' && (
              <div className="p-4 sm:p-6">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                  <h2 className="text-2xl font-bold">Aziende</h2>

                  <div className="flex flex-wrap gap-2">
                    {selectedCompanies.length > 0 && !showDeleteConfirm && (
                      <button onClick={() => setShowDeleteConfirm(true)}
                        className="bg-red-500 text-white px-4 py-2 rounded">
                        üóëÔ∏è Cancella ({selectedCompanies.length})
                      </button>
                    )}

                    {showDeleteConfirm && (
                      <div className="flex flex-wrap gap-2 items-center bg-red-50 border-2 border-red-500 px-4 py-2 rounded">
                        <span className="text-red-800 font-semibold">Confermi {selectedCompanies.length}?</span>
                        <button onClick={() => deleteCompanies(selectedCompanies)}
                          className="bg-red-600 text-white px-3 py-1 rounded font-bold">S√å</button>
                        <button onClick={() => setShowDeleteConfirm(false)}
                          className="bg-gray-600 text-white px-3 py-1 rounded">NO</button>
                      </div>
                    )}

                    <label className="bg-blue-600 text-white px-4 py-2 rounded cursor-pointer">
                      üì§ Importa CSV
                      <input type="file" accept=".csv" onChange={handleCSVImport} className="hidden" />
                    </label>
                  </div>
                </div>

                <div className="bg-white rounded shadow p-4 mb-4">
                  <input
                    type="text"
                    placeholder="Cerca (ragione sociale, P.IVA, email, telefono, settore)..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="border rounded px-3 py-2 w-full"
                  />
                </div>

                {selectedCompanies.length > 0 && (
                  <div className="bg-blue-50 border border-blue-200 rounded p-4 mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                    <span className="font-semibold">{selectedCompanies.length} selezionate</span>
                    <button onClick={toggleMicrophone}
                      className={`px-3 py-2 rounded ${isListening ? 'bg-red-500' : 'bg-blue-600'} text-white`}>
                      üé§ {isListening ? 'Stop' : 'Voce'}
                    </button>
                  </div>
                )}

                <div className="bg-white rounded shadow overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="min-w-[920px] w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="p-3 text-left w-10">
                            <input
                              type="checkbox"
                              checked={selectedCompanies.length === filtered.length && filtered.length > 0}
                              onChange={(e) => setSelectedCompanies(e.target.checked ? filtered.map(c => c.id) : [])}
                            />
                          </th>
                          <th className="p-3 text-left">Azienda</th>
                          <th className="p-3 text-left">P.IVA</th>
                          <th className="p-3 text-left">Stato</th>
                          <th className="p-3 text-left">Ricavi</th>
                          <th className="p-3 text-left">Azioni</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filtered.map(c => (
                          <tr key={c.id} className="border-t hover:bg-gray-50">
                            <td className="p-3">
                              <input
                                type="checkbox"
                                checked={selectedCompanies.includes(c.id)}
                                onChange={(e) => setSelectedCompanies(
                                  e.target.checked ? [...selectedCompanies, c.id] : selectedCompanies.filter(id => id !== c.id)
                                )}
                              />
                            </td>
                            <td className="p-3">
                              <div>
                                <p className="font-semibold">{c.ragioneSociale}</p>
                                {c.titolare ? <p className="text-xs text-gray-600">üë§ {c.titolare}</p> : null}
{c.evidenza && <p className="text-sm text-orange-600">‚≠ê {c.evidenza}</p>}
                                <p className="text-xs text-gray-500">{c.telefono}</p>
                              </div>
                            </td>
                            <td className="p-3 text-sm font-mono">{c.piva}</td>
                            <td className="p-3">
                              <span className={`px-2 py-1 rounded text-xs ${
                                c.stato === 'Acquisito' ? 'bg-green-100 text-green-800' :
                                c.stato === 'Contattato' ? 'bg-blue-100 text-blue-800' :
                                c.stato === 'Non interessato' ? 'bg-red-100 text-red-800' : 'bg-gray-100'
                              }`}>{c.stato}</span>
                            </td>
                            <td className="p-3 text-sm">{formatCurrency(c.ricavi)}</td>
                            <td className="p-3">
                              <button onClick={() => openDetail(c)} className="text-blue-600 hover:underline text-sm">
                                Dettagli
                              </button>
                            </td>
                          </tr>
                        ))}
                        {filtered.length === 0 && (
                          <tr>
                            <td colSpan="6" className="p-6 text-center text-gray-500">Nessun risultato</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {currentView === 'detail' && selectedCompany && (
              <div className="p-4 sm:p-6">
                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
                  <button onClick={() => { setCurrentView('companies'); setSelectedCompanyId(null); }}
                    className="text-blue-600 hover:underline">‚Üê Torna alla lista</button>

                  <div className="flex gap-2">
                    <button onClick={toggleMicrophone}
                      className={`px-4 py-2 rounded ${isListening ? 'bg-red-500' : 'bg-blue-600'} text-white`}>
                      üé§ {isListening ? 'Stop' : 'Comando Vocale'}
                    </button>
                    <button onClick={saveSelectedCompany} className="bg-green-600 text-white px-4 py-2 rounded">
                      üíæ Salva
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded shadow p-5 mb-6">
                  <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                    <div>
                      <h2 className="text-2xl font-bold mb-1">{selectedCompany.ragioneSociale}</h2>
                      <div className="text-sm text-gray-600">P.IVA: <span className="font-mono">{selectedCompany.piva}</span></div>
                    </div>
                    <div className="w-full lg:w-80">
                      <label className="text-sm text-gray-600 block mb-1">Stato</label>
                      <select
                        value={selectedCompany.stato}
                        onChange={(e) => {
                          if (e.target.value === '__new__') setShowNewStatoInput(true);
                          else updateSelectedCompanyLocal({ stato: e.target.value });
                        }}
                        className="border rounded px-3 py-2 w-full"
                      >
                        {statiPersonalizzati.map(s => <option key={s} value={s}>{s}</option>)}
                        <option value="__new__">+ Aggiungi nuovo stato</option>
                      </select>

                      {showNewStatoInput && (
                        <div className="mt-2 p-3 border rounded bg-gray-50">
                          <input
                            type="text"
                            value={newStatoName}
                            onChange={(e) => setNewStatoName(e.target.value)}
                            placeholder="Nome nuovo stato..."
                            className="border rounded px-3 py-2 w-full mb-2"
                            autoFocus
                          />
                          <div className="flex gap-2">
                            <button onClick={async () => {
                              const name = newStatoName.trim();
                              if (!name) return;
                              try {
                                const newList = [...statiPersonalizzati, name];
                                await persistStati(newList);
                                updateSelectedCompanyLocal({ stato: name });
                                setNewStatoName('');
                                setShowNewStatoInput(false);
                              } catch (e) {
                                alert(`Errore stati: ${e.message || e}`);
                              }
                            }} className="bg-green-600 text-white px-3 py-1 rounded text-sm">Aggiungi</button>
                            <button onClick={() => { setNewStatoName(''); setShowNewStatoInput(false); }}
                              className="bg-gray-600 text-white px-3 py-1 rounded text-sm">Annulla</button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {selectedCompany.evidenza && (
                    <div className="mt-4 bg-orange-50 border border-orange-200 rounded p-3">
                      <div className="font-semibold text-orange-800">‚≠ê {selectedCompany.evidenza}</div>
                    </div>
                  )}

                  <div className="mt-5 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                      <h3 className="font-semibold mb-3">Contatti</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex items-center gap-2">üìû
                          <input className="border rounded px-2 py-1 w-full" value={selectedCompany.telefono}
                            onChange={e=>updateSelectedCompanyLocal({ telefono: e.target.value })} />
                        </div>
                        <div className="flex items-center gap-2">‚úâÔ∏è
                          <input className="border rounded px-2 py-1 w-full" value={selectedCompany.email}
                            onChange={e=>updateSelectedCompanyLocal({ email: e.target.value })} />
                        </div>
                        
                        <div className="flex items-center gap-2">üë§
                          <input className="border rounded px-2 py-1 w-full" placeholder="Titolare (nome e cognome)" value={selectedCompany.titolare}
                            onChange={e=>updateSelectedCompanyLocal({ titolare: e.target.value })} />
                        </div>
<div className="flex items-center gap-2">üåê
                          <input className="border rounded px-2 py-1 w-full" value={selectedCompany.sitoWeb}
                            onChange={e=>updateSelectedCompanyLocal({ sitoWeb: e.target.value })} />
                        </div>
                        <div className="flex items-start gap-2">üìç
                          <textarea className="border rounded px-2 py-1 w-full" rows="2" value={selectedCompany.indirizzo}
                            onChange={e=>updateSelectedCompanyLocal({ indirizzo: e.target.value })} />
                        </div>
                      </div>
                    </div>

                    <div>
                      <h3 className="font-semibold mb-3">Economici</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between"><span className="text-gray-600">Capitale Sociale</span><span className="font-semibold">{formatCurrency(selectedCompany.capitaleSociale)}</span></div>
                        <div className="flex justify-between"><span className="text-gray-600">Valore Produzione</span><span className="font-semibold">{formatCurrency(selectedCompany.valoreProduzione)}</span></div>
                        <div className="flex justify-between"><span className="text-gray-600">Ricavi</span><span className="font-semibold">{formatCurrency(selectedCompany.ricavi)}</span></div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">Utile/Perdite</span>
                          <span className={`font-semibold ${selectedCompany.utileOPerdite >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                            {formatCurrency(selectedCompany.utileOPerdite)}
                          </span>
                        </div>
                      </div>

                      <div className="mt-5 grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <label className="text-gray-600">Dipendenti</label>
                          <input className="border rounded px-2 py-1 w-full" value={selectedCompany.dipendenti}
                            onChange={e=>updateSelectedCompanyLocal({ dipendenti: parseInt(e.target.value||'0')||0 })} />
                        </div>
                        <div>
                          <label className="text-gray-600">Collaboratori</label>
                          <input className="border rounded px-2 py-1 w-full" value={selectedCompany.collaboratori}
                            onChange={e=>updateSelectedCompanyLocal({ collaboratori: parseInt(e.target.value||'0')||0 })} />
                        </div>
                      </div>

                      <div className="mt-4 text-sm">
                        <label className="text-gray-600">Settore</label>
                        <input className="border rounded px-2 py-1 w-full" value={selectedCompany.settore}
                          onChange={e=>updateSelectedCompanyLocal({ settore: e.target.value })} />
                      </div>

                      <div className="mt-4 text-sm">
                        <label className="text-gray-600">Evidenza</label>
                        <input className="border rounded px-2 py-1 w-full" value={selectedCompany.evidenza}
                          onChange={e=>updateSelectedCompanyLocal({ evidenza: e.target.value })} />
                      </div>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded shadow p-5">
                  <h3 className="text-xl font-bold mb-4">Timeline Interazioni</h3>

                  <div className="space-y-3">
                    {(selectedCompany.timeline || []).map((t, idx) => (
                      <div key={t.id}
                        className={`border-l-4 border-blue-600 pl-4 py-2 ${draggedNoteIndex === idx ? 'opacity-50' : ''} ${deletingNote === t.id ? 'bg-red-50' : ''}`}
                        draggable={editingNote !== t.id}
                        onDragStart={() => setDraggedNoteIndex(idx)}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={() => {
                          if (draggedNoteIndex !== null && draggedNoteIndex !== idx) {
                            const newTimeline = [...(selectedCompany.timeline || [])];
                            const [draggedItem] = newTimeline.splice(draggedNoteIndex, 1);
                            newTimeline.splice(idx, 0, draggedItem);
                            updateSelectedCompanyLocal({ timeline: newTimeline });
                          }
                          setDraggedNoteIndex(null);
                        }}
                        onDragEnd={() => setDraggedNoteIndex(null)}
                      >
                        {deletingNote === t.id ? (
                          <div className="flex items-center justify-between p-2">
                            <span className="text-red-800 font-semibold">Confermi eliminazione?</span>
                            <div className="flex gap-2">
                              <button onClick={() => {
                                const newTimeline = (selectedCompany.timeline || []).filter(tn => tn.id !== t.id);
                                updateSelectedCompanyLocal({ timeline: newTimeline });
                                setDeletingNote(null);
                              }} className="bg-red-600 text-white px-3 py-1 rounded text-sm font-bold">S√å</button>
                              <button onClick={() => setDeletingNote(null)} className="bg-gray-600 text-white px-3 py-1 rounded text-sm">NO</button>
                            </div>
                          </div>
                        ) : editingNote === t.id ? (
                          <div>
                            <textarea value={newNoteText} onChange={(e) => setNewNoteText(e.target.value)}
                              className="w-full border rounded px-3 py-2 mb-2" rows="3" autoFocus />
                            <div className="flex gap-2">
                              <button onClick={() => {
                                const newTimeline = (selectedCompany.timeline || []).map(tn => tn.id === t.id ? { ...tn, testo: newNoteText } : tn);
                                updateSelectedCompanyLocal({ timeline: newTimeline });
                                setEditingNote(null);
                                setNewNoteText('');
                              }} className="bg-green-600 text-white px-3 py-1 rounded text-sm">Salva</button>
                              <button onClick={() => { setEditingNote(null); setNewNoteText(''); }} className="bg-gray-600 text-white px-3 py-1 rounded text-sm">Annulla</button>
                            </div>
                          </div>
                        ) : (
                          <>
                            <div className="flex justify-between mb-1">
                              <div className="flex items-center gap-2">
                                <span className="cursor-move text-gray-400" title="Trascina per riordinare">‚ãÆ‚ãÆ</span>
                                <span className="text-xs px-2 py-1 bg-gray-100 rounded">{t.tipo}</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-gray-500">{formatDateTime(t.data)}</span>
                                <button onClick={() => { setEditingNote(t.id); setNewNoteText(t.testo); }}
                                  className="text-blue-700 text-xs" title="Modifica">‚úèÔ∏è</button>
                                <button onClick={() => setDeletingNote(t.id)}
                                  className="text-red-700 text-xs" title="Elimina">üóëÔ∏è</button>
                              </div>
                            </div>
                            <p className="text-sm">{t.testo}</p>
                          </>
                        )}
                      </div>
                    ))}
                    {(selectedCompany.timeline || []).length === 0 && (
                      <div className="text-sm text-gray-500">Nessuna interazione registrata.</div>
                    )}
                  </div>

                  {!showNoteInput ? (
                    <button onClick={() => setShowNoteInput(true)} className="bg-blue-600 text-white px-4 py-2 rounded mt-4">
                      ‚ûï Aggiungi Nota
                    </button>
                  ) : (
                    <div className="mt-4 border rounded p-4 bg-gray-50">
                      <textarea value={newNoteText} onChange={(e) => setNewNoteText(e.target.value)}
                        placeholder="Scrivi la nota..." className="w-full border rounded px-3 py-2 mb-2" rows="3" autoFocus />
                      <div className="flex gap-2">
                        <button onClick={() => {
                          if (newNoteText.trim()) {
                            const entry = {
                              id: `t_${Date.now()}_${Math.random().toString(36).slice(2)}`,
                              data: new Date().toISOString(),
                              tipo: 'nota',
                              testo: newNoteText,
                              operatore: 'Utente'
                            };
                            updateSelectedCompanyLocal({ timeline: [entry, ...(selectedCompany.timeline || [])] });
                            setNewNoteText('');
                            setShowNoteInput(false);
                          }
                        }} className="bg-green-600 text-white px-4 py-2 rounded">Salva</button>
                        <button onClick={() => { setNewNoteText(''); setShowNoteInput(false); }} className="bg-gray-600 text-white px-4 py-2 rounded">Annulla</button>
                      </div>
                    </div>
                  )}

                  <div className="mt-4 text-xs text-gray-500">
                    Nota: dopo modifiche su Timeline/Contatti/Evidenza clicca ‚ÄúSalva‚Äù.
                  </div>
                </div>
              </div>
            )}

            {currentView === 'settings-stati' && (
              <div className="p-4 sm:p-6">
                <h2 className="text-2xl font-bold mb-6">Gestione Stati</h2>
                <div className="bg-white rounded shadow p-6">
                  <p className="text-sm text-gray-600 mb-4">Riordina gli stati usando le frecce. L'ordine determina la priorit√†.</p>

                  <div className="space-y-2">
                    {statiPersonalizzati.map((stato, idx) => (
                      <div key={stato} className="flex items-center justify-between border rounded p-3 bg-gray-50">
                        <span className="font-semibold">{idx + 1}. {stato}</span>
                        <div className="flex gap-2">
                          {idx > 0 && (
                            <button onClick={async () => {
                              try {
                                const newList = [...statiPersonalizzati];
                                [newList[idx], newList[idx-1]] = [newList[idx-1], newList[idx]];
                                await persistStati(newList);
                              } catch (e) { alert(`Errore: ${e.message || e}`); }
                            }} className="bg-blue-600 text-white px-2 py-1 rounded text-sm">‚Üë</button>
                          )}
                          {idx < statiPersonalizzati.length - 1 && (
                            <button onClick={async () => {
                              try {
                                const newList = [...statiPersonalizzati];
                                [newList[idx], newList[idx+1]] = [newList[idx+1], newList[idx]];
                                await persistStati(newList);
                              } catch (e) { alert(`Errore: ${e.message || e}`); }
                            }} className="bg-blue-600 text-white px-2 py-1 rounded text-sm">‚Üì</button>
                          )}
                          <button onClick={async () => {
                            if (!confirm(`Eliminare lo stato "${stato}"?`)) return;
                            try {
                              const newList = statiPersonalizzati.filter(s => s !== stato);
                              await persistStati(newList);
                            } catch (e) { alert(`Errore: ${e.message || e}`); }
                          }} className="bg-red-600 text-white px-2 py-1 rounded text-sm">Elimina</button>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="mt-6">
                    <h3 className="font-semibold mb-2">Aggiungi Nuovo Stato</h3>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={newStatoName}
                        onChange={(e) => setNewStatoName(e.target.value)}
                        placeholder="Nome stato..."
                        className="border rounded px-3 py-2 flex-1"
                        onKeyDown={async (e) => {
                          if (e.key === 'Enter') {
                            const name = newStatoName.trim();
                            if (!name) return;
                            try {
                              const newList = [...statiPersonalizzati, name];
                              await persistStati(newList);
                              setNewStatoName('');
                            } catch (err) { alert(`Errore: ${err.message || err}`); }
                          }
                        }}
                      />
                      <button onClick={async () => {
                        const name = newStatoName.trim();
                        if (!name) return;
                        try {
                          const newList = [...statiPersonalizzati, name];
                          await persistStati(newList);
                          setNewStatoName('');
                        } catch (err) { alert(`Errore: ${err.message || err}`); }
                      }} className="bg-green-600 text-white px-4 py-2 rounded">Aggiungi</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            
            {currentView === 'followup' && (
              <div className="p-4 sm:p-6 space-y-6">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <div>
                    <h2 className="text-2xl font-bold">Follow-up</h2>
                    <p className="text-sm text-gray-600">Slot (follow-up) e blocchi pianificati. Clicca uno slot per vedere l‚Äôelenco e creare un blocco.</p>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={async () => {
                        const nome = prompt('Nome slot (es. "Luned√¨ mattina")');
                        if (!nome) return;
                        const regole = prompt('Regole (testo libero, opzionale). Esempio: "Lun 8-12"', '') || '';
                        try {
                          const { data, error } = await supabase
                            .from('followup_slots')
                            .insert({ user_id: userId, nome: nome.trim(), regole })
                            .select('*')
                            .single();
                          if (error) throw error;
                          setFollowupSlots(prev => [...prev, data]);
                          notify('success', 'Slot creato.');
                        } catch (e) {
                          notify('error', e.message || String(e));
                        }
                      }}
                      className="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                    >
                      Nuovo slot
                    </button>
                    <button
                      onClick={async () => { try { await loadBlocks(); await loadCompanies(); notify('success','Aggiornato.'); } catch(e){ notify('error', e.message || String(e)); } }}
                      className="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200"
                    >
                      Aggiorna
                    </button>
                  </div>
                </div>

                {/* Lista slot */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <div className="bg-white rounded shadow p-4">
                    <h3 className="font-semibold mb-3">Slot</h3>
                    <div className="space-y-2">
                      {(followupSlots || []).length === 0 && (
                        <div className="text-sm text-gray-500">Nessuno slot ancora. Clicca ‚ÄúNuovo slot‚Äù.</div>
                      )}
                      {(followupSlots || []).map(s => {
                        const count = (companies || []).filter(c => c.followupSlotId === s.id && !c.plannedBlockId).length;
                        const plannedCount = (companies || []).filter(c => c.followupSlotId === s.id && c.plannedBlockId).length;
                        return (
                          <button
                            key={s.id}
                            onClick={() => { setSlotDetailId(s.id); setSelectedInSlot([]); }}
                            className={`w-full text-left px-3 py-2 rounded border ${slotDetailId === s.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'}`}
                          >
                            <div className="flex items-center justify-between gap-2">
                              <div className="font-medium">{s.nome}</div>
                              <div className="text-xs text-gray-600">{count} da pianificare ‚Ä¢ {plannedCount} pianificate</div>
                            </div>
                            {s.regole ? <div className="text-xs text-gray-500 mt-1">{s.regole}</div> : null}
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* Dettaglio slot */}
                  <div className="lg:col-span-2 bg-white rounded shadow p-4">
                    {!slotDetailId ? (
                      <div className="text-sm text-gray-600">Seleziona uno slot a sinistra.</div>
                    ) : (
                      (() => {
                        const slot = (followupSlots || []).find(s => s.id === slotDetailId);
                        const slotName = slot ? slot.nome : '';
                        const list = (companies || []).filter(c => c.followupSlotId === slotDetailId && !c.plannedBlockId);
                        const ordered = [...list].sort((a,b) => {
                          const pa = statusPriorityIndex(a.stato);
                          const pb = statusPriorityIndex(b.stato);
                          if (pa !== pb) return pa - pb;
                          const da = a.followupEnteredAt ? new Date(a.followupEnteredAt).getTime() : 0;
                          const db = b.followupEnteredAt ? new Date(b.followupEnteredAt).getTime() : 0;
                          return da - db;
                        });

                        const allSelected = ordered.length > 0 && selectedInSlot.length === ordered.length;

                        return (
                          <div className="space-y-4">
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                              <div>
                                <h3 className="text-xl font-semibold">{slotName}</h3>
                                <div className="text-sm text-gray-600">{ordered.length} aziende da pianificare</div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <button
                                  onClick={() => setSelectedInSlot(allSelected ? [] : ordered.map(c => c.id))}
                                  className="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm"
                                >
                                  {allSelected ? 'Deseleziona tutte' : 'Seleziona tutte'}
                                </button>
                                <button
                                  onClick={() => {
                                    const now = new Date();
                                    const yyyy = now.getFullYear();
                                    const mm = String(now.getMonth()+1).padStart(2,'0');
                                    const dd = String(now.getDate()).padStart(2,'0');
                                    setBlockWizard({
                                      open: true,
                                      slotId: slotDetailId,
                                      start: `${yyyy}-${mm}-${dd}T09:00`,
                                      end: `${yyyy}-${mm}-${dd}T10:00`,
                                      durationMin: 10
                                    });
                                  }}
                                  className="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm"
                                >
                                  Crea blocco
                                </button>
                              </div>
                            </div>

                            <div className="overflow-auto border rounded">
                              <table className="min-w-full text-sm">
                                <thead className="bg-gray-50">
                                  <tr>
                                    <th className="px-3 py-2 w-10"></th>
                                    <th className="px-3 py-2 text-left">Azienda</th>
                                    <th className="px-3 py-2 text-left">Stato</th>
                                    <th className="px-3 py-2 text-left">Telefono</th>
                                    <th className="px-3 py-2 text-left">Entrata slot</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {ordered.map(c => {
                                    const checked = selectedInSlot.includes(c.id);
                                    return (
                                      <tr key={c.id} className="border-t hover:bg-gray-50">
                                        <td className="px-3 py-2">
                                          <input type="checkbox" checked={checked}
                                            onChange={(e) => {
                                              if (e.target.checked) setSelectedInSlot(prev => [...prev, c.id]);
                                              else setSelectedInSlot(prev => prev.filter(x => x !== c.id));
                                            }}
                                          />
                                        </td>
                                        <td className="px-3 py-2">
                                          <button className="text-blue-600 hover:underline"
                                            onClick={() => { setSelectedCompany(c); setCurrentView('companies'); }}
                                          >
                                            {c.ragioneSociale}
                                          </button>
                                        </td>
                                        <td className="px-3 py-2">{c.stato}</td>
                                        <td className="px-3 py-2">{c.telefono}</td>
                                        <td className="px-3 py-2">{c.followupEnteredAt ? new Date(c.followupEnteredAt).toLocaleString() : ''}</td>
                                      </tr>
                                    );
                                  })}
                                  {ordered.length === 0 && (
                                    <tr><td colSpan="5" className="px-3 py-6 text-center text-gray-500">Nessuna azienda da pianificare in questo slot.</td></tr>
                                  )}
                                </tbody>
                              </table>
                            </div>

                            <div className="border-t pt-4">
                              <h4 className="font-semibold mb-2">Blocchi pianificati (aperti) per questo slot</h4>
                              <div className="space-y-2">
                                {(blocks || []).filter(b => b.slot_id === slotDetailId).slice(0, 10).map(b => {
                                  const planned = (companies || []).filter(c => c.plannedBlockId === b.id).length;
                                  const overdue = new Date(b.end_at).getTime() < Date.now();
                                  return (
                                    <div key={b.id} className={`p-3 rounded border ${overdue ? 'border-red-300 bg-red-50' : 'border-gray-200'}`}>
                                      <div className="flex items-center justify-between gap-3">
                                        <div>
                                          <div className="font-medium">{b.titolo}</div>
                                          <div className="text-xs text-gray-600">
                                            {new Date(b.start_at).toLocaleString()} ‚Üí {new Date(b.end_at).toLocaleString()} ‚Ä¢ {planned} aziende
                                            {overdue ? ' ‚Ä¢ SCADUTO' : ''}
                                          </div>
                                        </div>
                                        <button className="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm"
                                          onClick={() => { window.location.hash = `block=${b.id}`; setCurrentBlockId(b.id); setCurrentView('block'); }}
                                        >
                                          Apri
                                        </button>
                                      </div>
                                    </div>
                                  );
                                })}
                                {(blocks || []).filter(b => b.slot_id === slotDetailId).length === 0 && (
                                  <div className="text-sm text-gray-500">Nessun blocco ancora.</div>
                                )}
                              </div>
                            </div>

                            {/* Wizard blocco */}
                            {blockWizard.open && (
                              <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded shadow-lg w-full max-w-xl p-5 space-y-4">
                                  <div className="flex items-center justify-between">
                                    <h3 className="text-lg font-bold">Crea blocco</h3>
                                    <button onClick={() => setBlockWizard(prev => ({...prev, open:false}))} className="text-gray-500 hover:text-gray-700">‚úï</button>
                                  </div>

                                  <div className="text-sm text-gray-600">
                                    Slot: <span className="font-semibold">{getSlotName(blockWizard.slotId)}</span> ‚Ä¢ Aziende selezionate: <span className="font-semibold">{selectedInSlot.length}</span>
                                  </div>

                                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                      <label className="text-sm font-medium">Inizio</label>
                                      <input type="datetime-local" value={blockWizard.start}
                                        onChange={(e)=>setBlockWizard(prev=>({...prev,start:e.target.value}))}
                                        className="w-full border rounded px-3 py-2"
                                      />
                                    </div>
                                    <div>
                                      <label className="text-sm font-medium">Fine</label>
                                      <input type="datetime-local" value={blockWizard.end}
                                        onChange={(e)=>setBlockWizard(prev=>({...prev,end:e.target.value}))}
                                        className="w-full border rounded px-3 py-2"
                                      />
                                    </div>
                                  </div>

                                  <div className="flex gap-2 justify-end">
                                    <button onClick={() => setBlockWizard(prev => ({...prev, open:false}))}
                                      className="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200"
                                    >
                                      Annulla
                                    </button>
                                    <button
                                      onClick={async () => {
                                        try {
                                          if (!selectedInSlot.length) { notify('error','Seleziona almeno un‚Äôazienda.'); return; }
                                          const startISO = new Date(blockWizard.start).toISOString();
                                          const endISO = new Date(blockWizard.end).toISOString();
                                          const block = await createFollowupBlock({ slotId: blockWizard.slotId, companyIds: selectedInSlot, startISO, endISO });

                                          // Link calendario
                                          const details = `Apri elenco chiamate nel CRM: ${crmBaseUrl()}#block=${block.id}`;
                                          const gcal = googleCalendarLink({ title: block.titolo, startISO, endISO, details });

                                          setBlockWizard(prev => ({...prev, open:false}));
                                          setSelectedInSlot([]);
                                          notify('success', 'Blocco creato. Si aprir√† la pagina del blocco; link Calendar pronto.');

                                          // Apri blocco
                                          window.location.hash = `block=${block.id}`;
                                          setCurrentBlockId(block.id);
                                          setCurrentView('block');

                                          // apri in una nuova tab il link calendar
                                          window.open(gcal, '_blank');
                                        } catch (e) {
                                          notify('error', e.message || String(e));
                                        }
                                      }}
                                      className="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                                    >
                                      Conferma e crea
                                    </button>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })()
                    )}
                  </div>
                </div>
              </div>
            )}

            {currentView === 'block' && (
              <div className="p-4 sm:p-6 space-y-6">
                {(() => {
                  const id = currentBlockId;
                  const block = (blocks || []).find(b => b.id === id);
                  if (!id) return <div className="text-sm text-gray-600">Nessun blocco selezionato.</div>;
                  if (!block) return <div className="text-sm text-gray-600">Blocco non trovato. Premi ‚ÄúAggiorna‚Äù in Follow-up.</div>;

                  const plannedCompanies = (companies || []).filter(c => c.plannedBlockId === block.id).sort((a,b) => {
                    const pa = statusPriorityIndex(a.stato);
                    const pb = statusPriorityIndex(b.stato);
                    if (pa !== pb) return pa - pb;
                    const da = a.plannedAt ? new Date(a.plannedAt).getTime() : 0;
                    const db = b.plannedAt ? new Date(b.plannedAt).getTime() : 0;
                    return da - db;
                  });

                  const overdue = new Date(block.end_at).getTime() < Date.now();
                  const startISO = block.start_at;
                  const endISO = block.end_at;

                  const details = `Apri elenco chiamate nel CRM: ${crmBaseUrl()}#block=${block.id}`;
                  const gcal = googleCalendarLink({ title: block.titolo, startISO, endISO, details });

                  return (
                    <div className="space-y-4">
                      <div className={`p-4 rounded border ${overdue ? 'border-red-300 bg-red-50' : 'border-gray-200 bg-white'}`}>
                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                          <div>
                            <h2 className="text-2xl font-bold">{block.titolo}</h2>
                            <div className="text-sm text-gray-700">
                              Slot: <span className="font-semibold">{getSlotName(block.slot_id)}</span> ‚Ä¢ {new Date(block.start_at).toLocaleString()} ‚Üí {new Date(block.end_at).toLocaleString()}
                              {overdue ? <span className="ml-2 font-semibold text-red-700">SCADUTO</span> : null}
                            </div>
                            <div className="text-xs text-gray-600 mt-1">Link diretto: {crmBaseUrl()}#block={block.id}</div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a href={gcal} target="_blank" rel="noreferrer" className="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm">Apri in Google Calendar</a>
                            <button onClick={() => { setCurrentView('followup'); setSlotDetailId(block.slot_id); }}
                              className="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">
                              Torna allo slot
                            </button>
                          </div>
                        </div>
                      </div>

                      <div className="bg-white rounded shadow p-4">
                        <h3 className="font-semibold mb-3">Aziende nel blocco ({plannedCompanies.length})</h3>
                        <div className="overflow-auto border rounded">
                          <table className="min-w-full text-sm">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-3 py-2 text-left">Azienda</th>
                                <th className="px-3 py-2 text-left">Stato</th>
                                <th className="px-3 py-2 text-left">Telefono</th>
                                <th className="px-3 py-2 text-left">Pianificata</th>
                              </tr>
                            </thead>
                            <tbody>
                              {plannedCompanies.map(c => (
                                <tr key={c.id} className="border-t hover:bg-gray-50">
                                  <td className="px-3 py-2">
                                    <button className="text-blue-600 hover:underline"
                                      onClick={() => { setSelectedCompany(c); setCurrentView('companies'); }}
                                    >
                                      {c.ragioneSociale}
                                    </button>
                                  </td>
                                  <td className="px-3 py-2">{c.stato}</td>
                                  <td className="px-3 py-2">{c.telefono}</td>
                                  <td className="px-3 py-2">{c.plannedAt ? new Date(c.plannedAt).toLocaleString() : ''}</td>
                                </tr>
                              ))}
                              {plannedCompanies.length === 0 && (
                                <tr><td colSpan="4" className="px-3 py-6 text-center text-gray-500">Nessuna azienda associata (forse sono state spostate di follow-up).</td></tr>
                              )}
                            </tbody>
                          </table>
                        </div>

                        <div className="text-sm text-gray-600 mt-4">
                          Nota: se cambi il follow-up di una di queste aziende (comando vocale ‚Äúfollow-up ‚Ä¶‚Äù o da scheda), l‚Äôazienda viene automaticamente rimossa dal blocco (pianificazione azzerata).
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}


{currentView === 'voice-help' && (
              <div className="p-4 sm:p-6">
                <h2 className="text-2xl font-bold mb-6">Comandi vocali</h2>
                <div className="bg-white rounded shadow p-6 space-y-4">
                  <p className="text-gray-700">Puoi parlare dopo aver premuto <b>üéôÔ∏è Voce</b>. Il sistema riconosce frasi ‚Äúnaturali‚Äù ma queste sono le pi√π affidabili.</p>

                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="text-left border-b">
                          <th className="py-2 pr-4">Comando</th>
                          <th className="py-2 pr-4">Effetto</th>
                          <th className="py-2">Esempio</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y">
                        <tr>
                          <td className="py-2 pr-4 font-mono">aggiungi nota ...</td>
                          <td className="py-2 pr-4">Aggiunge una nota in timeline (data/ora + testo) all‚Äôazienda selezionata (o a pi√π aziende, se le hai selezionate).</td>
                          <td className="py-2">‚Äúaggiungi nota richiamare domani alle 10‚Äù</td>
                        </tr>
                        <tr>
                          <td className="py-2 pr-4 font-mono">evidenza ...</td>
                          <td className="py-2 pr-4">Imposta il campo <b>Evidenza</b> (testo breve) dell‚Äôazienda.</td>
                          <td className="py-2">‚Äúevidenza titolare in ferie fino al 20‚Äù</td>
                        </tr>
                        <tr>
                          <td className="py-2 pr-4 font-mono">imposta stato ...</td>
                          <td className="py-2 pr-4">Cambia lo <b>Stato</b> dell‚Äôazienda (deve essere uno degli stati presenti in Impostazioni ‚Üí Gestione Stati).</td>
                          <td className="py-2">‚Äúimposta stato Contattato‚Äù</td>
                        </tr>
                        <tr>
                          <td className="py-2 pr-4 font-mono">apri aziende</td>
                          <td className="py-2 pr-4">Vai alla schermata Aziende.</td>
                          <td className="py-2">‚Äúapri aziende‚Äù</td>
                        </tr>
                        <tr>
                          <td className="py-2 pr-4 font-mono">apri dashboard</td>
                          <td className="py-2 pr-4">Vai alla Dashboard.</td>
                          <td className="py-2">‚Äúapri dashboard‚Äù</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div className="bg-blue-50 border border-blue-200 rounded p-4">
                    <p className="text-blue-900"><b>Controllo totale:</b> ogni comando che modifica dati mostra sempre un popup di riepilogo con <i>Conferma</i>/<i>Annulla</i>.</p>
                  </div>
                </div>
              </div>
            )}
)}

        {voiceReview.open && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
              <h3 className="text-lg font-bold mb-2">Conferma modifiche (comando vocale)</h3>
              <div className="text-sm bg-gray-50 border rounded p-3 whitespace-pre-wrap max-h-72 overflow-auto">{voiceReview.summary}</div>
              <div className="mt-4 flex justify-end gap-2">
                <button
                  className="px-4 py-2 rounded border"
                  onClick={() => setVoiceReview({ open: false, summary: '', updated: [], working: false })}
                  disabled={voiceReview.working}
                >
                  Annulla
                </button>
                <button
                  className="px-4 py-2 rounded bg-blue-600 text-white"
                  onClick={async () => {
                    try {
                      setVoiceReview(v => ({ ...v, working: true }));
                      for (const c of voiceReview.updated) {
                        await saveCompany(c);
                      }
                      alert('Modifiche salvate.');
                    } catch (err) {
                      notify('error', `Errore salvataggio modifiche: ${err.message || err}`);
                    } finally {
                      setVoiceReview({ open: false, summary: '', updated: [], working: false });
                    }
                  }}
                  disabled={voiceReview.working}
                >
                  {voiceReview.working ? 'Salvo‚Ä¶' : 'Conferma'}
                </button>
              </div>
            </div>
          </div>
        )}

          {toast && (
            <div className="fixed bottom-4 right-4 z-50 max-w-sm">
              <div className={
                "rounded-lg shadow-lg border px-4 py-3 text-sm " +
                (toast.type === 'error'
                  ? "bg-red-50 border-red-200 text-red-800"
                  : toast.type === 'success'
                    ? "bg-green-50 border-green-200 text-green-800"
                    : "bg-blue-50 border-blue-200 text-blue-800")
              }>
                {toast.text}
              </div>
            </div>
          )}

          </main>
        </div>
      );
    };

    // Mount React 18
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CRMLeadManager />);
  </script>
</body>
</html>
